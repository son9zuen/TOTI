<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yal.toti.kang.dao.RequestDaoInterface">

	<!-- 분야 리스트 -->
	<select id="categorieList" resultType="com.yal.toti.kang.domain.CategoriData">
		select * from toti_cate
	</select>
	
	<!-- 분야번호에 맞는 분야명 -->
	<select id="cate_naem" resultType="String" parameterType="int">
		select cate_name from toti_cate where cate_idx=#{cate_idx}
	</select>
	
	<!-- 분야번호에 맞는 서비스번호, 서비스명 리스트 -->
	<select id="serviceData" resultType="com.yal.toti.kang.domain.ServiceData" parameterType="int">
		select s.service_idx, s.service_name from toti_cate c join toti_service s 
		on c.cate_idx = s.cate_idx
		where c.cate_idx=#{cate_idx}
	</select>
	
	<!-- 분야번호에 맞는 질문번호, 질문 -->
	<select id="questData" resultType="com.yal.toti.kang.domain.QuestionsData" parameterType="int">
		select q.quest_idx, q.quest_name, q.quest_type  from toti_cate c join toti_question q 
		on c.cate_idx = q.cate_idx
		where c.cate_idx=#{cate_idx} or c.cate_idx=4
	</select>
	
	<!-- 질문번호에 맞는 항목 -->
	<select id="itemListData" resultType="com.yal.toti.kang.domain.ItemListData">
		select item_idx, item_cont from toti_question join toti_item
		using(quest_idx)
		where quest_idx=#{quest_idx}
	</select>
	
	<!-- 요청서 등록 -->
	<insert id="insertRequest" keyProperty="request_idx" useGeneratedKeys="true" parameterType="com.yal.toti.kang.domain.RequestData">
		insert into toti_request (m_idx, cate_idx) values (#{m_idx}, #{cate_idx})
	</insert>
	
	<!-- 서비스 등록 -->
	<insert id="insertService" parameterType="com.yal.toti.kang.domain.RequestData">
		insert into toti_mentee_service (request_idx, m_idx, service_idx) values
		(#{request_idx}, #{m_idx}, #{service_idx})
	</insert>
	
	<!-- 답변 등록 -->
	<insert id="insertAnswer" parameterType="java.util.Map">
		insert into toti_answer (request_idx, quest_idx, answer_cont) values
		<foreach collection="answerDatas" item="item" separator=",">
			(#{request_idx}, #{item.qurest_idx}, #{item.answer_cont})
		</foreach>
	</insert>
	
	<!-- 요청서 정보 -->
	<select id="getUserRequestData" resultType="com.yal.toti.kang.domain.UserRequestData" parameterType="int">
		SELECT r.request_idx, quest_name, answer_cont, m_name, m_photo,cate_name, service_name, date_format(r.request_date, '%y-%m-%d %H:%i') request_date FROM toti.toti_answer a 
		join toti.toti_question q on q.quest_idx = a.quest_idx 
		join toti.toti_request r on r.request_idx = a.request_idx join toti.toti_member m on m.m_idx = r.m_idx 
		join toti.toti_cate c on q.cate_idx = c.cate_idx
		left outer join (select cate_idx, service_name, m_idx from toti.toti_service se 
		join toti.toti_mentee_service tee on se.service_idx = tee.service_idx ) cate on cate.cate_idx = c.cate_idx
		where r.request_idx=#{request_idx};
	</select>
	
</mapper>


 
 